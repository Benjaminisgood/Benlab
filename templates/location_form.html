{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">{{ location and '编辑位置' or '新增位置' }}</h4>
<form method="post" enctype="multipart/form-data" action="{% if location %}{{ url_for('edit_location', loc_id=location.id) }}{% else %}{{ url_for('add_location') }}{% endif %}">
  <div class="mb-3">
    <label for="name" class="form-label">位置名称</label>
    <input type="text" class="form-control" id="name" name="name" value="{{ location.name if location else '' }}" required>
  </div>
  <div class="mb-3">
    <label for="responsible" class="form-label">负责人</label>
    <select id="responsible" name="responsible_ids" class="form-select" multiple>
      {% for m in members %}
        <option value="{{ m.id }}"
          {% if location and m in location.responsible_members %}selected{% endif %}>
          {{ m.name }}
        </option>
      {% endfor %}
    </select>
    <div class="form-text">可多选负责人，按住 Ctrl (Windows) 或 Cmd (Mac) 选择多个人。</div>
  </div>
  <div class="form-text">父位置用于层级组织，留空表示顶层位置。</div>
  <div class="mb-3">
    <label for="parent_id" class="form-label">父位置（可选）</label>
    <select name="parent_id" id="parent_id" class="form-select">
      <option value="">无</option>
      {% for parent in parents %}
        {% if not (location and parent.id == location.id) %}
          <option value="{{ parent.id }}"
            {% if location and location.parent_id == parent.id %}selected{% endif %}>
            {{ parent.name }}
          </option>
        {% endif %}
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label for="clean_status" class="form-label">卫生状态</label>
    <select name="clean_status" class="form-select">
      <option value="">-- 请选择 --</option>
      {% for opt in ['干净', '一般', '脏/报修'] %}
        <option value="{{ opt }}" {% if location and location.clean_status == opt %}selected{% endif %}>{{ opt }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="mb-3">
    <label for="detail_link" class="form-label">详情链接</label>
    <input type="url" class="form-control" id="detail_link" name="detail_link"
          value="{{ location.detail_link if location else '' }}" placeholder="https://example.com">
    <div class="form-text">可填写位置的相关详情链接（可选）</div>
  </div>
  <div class="mb-3">
    <label for="imageInput" class="form-label">位置图片 (可选，可多选)</label>
    {% if location %}
    <div class="d-flex flex-wrap gap-3 mb-2">
      {% set legacy_only = location.image and (location.images | selectattr('filename', 'equalto', location.image) | list | length == 0) %}
      {% if legacy_only %}
      <div class="text-center">
        <img src="{{ uploaded_image_url(location.image) }}" alt="位置图片" class="img-thumbnail" style="max-width:150px;">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" name="remove_primary_image" value="1" id="removePrimaryLocationImage">
          <label class="form-check-label" for="removePrimaryLocationImage">删除此图</label>
        </div>
      </div>
      {% endif %}
      {% for gallery_image in location.images %}
      <div class="text-center">
        <img src="{{ uploaded_image_url(gallery_image.filename) }}" alt="位置图片" class="img-thumbnail" style="max-width:150px;">
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" name="remove_image_ids" value="{{ gallery_image.id }}" id="removeLocationImage{{ gallery_image.id }}">
          <label class="form-check-label" for="removeLocationImage{{ gallery_image.id }}">删除此图</label>
        </div>
      </div>
      {% endfor %}
      {% if not (legacy_only or location.images) %}
      <p class="text-muted mb-0">暂无已上传图片</p>
      {% endif %}
    </div>
    {% endif %}
    <input type="file" id="imageInput" name="images" accept="image/*" capture="environment" class="form-control" multiple>
    <img id="imgPreview" src="#" alt="预览" style="max-width: 120px; display: none; margin-top: 5px;">
  </div>
  <div class="mb-3">
    <label for="notes" class="form-label">备注</label>
    <textarea class="form-control" id="notes" name="notes" rows="3">{{ location.notes if location else '' }}</textarea>
  </div>
  <button type="submit" class="btn btn-success">{{ location and '保存修改' or '添加位置' }}</button>
  <a href="{{ url_for('locations_list') }}" class="btn btn-secondary">取消</a>
</form>
<script>
  // 图片预览脚本
  const fileInput2 = document.getElementById('imageInput');
  const previewImg2 = document.getElementById('imgPreview');
  if(fileInput2 && previewImg2) {
    fileInput2.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if(file) {
        previewImg2.src = URL.createObjectURL(file);
        previewImg2.style.display = 'block';
      } else {
        previewImg2.style.display = 'none';
      }
    });
  }
</script>
{% endblock %}
