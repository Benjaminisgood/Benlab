<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OpenMind Hub</title>
  <script>
    (function () {
      var STORAGE_KEY = 'benlab-theme';
      var docEl = document.documentElement;
      try {
        var stored = window.localStorage.getItem(STORAGE_KEY);
        var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        var theme = stored || (prefersDark ? 'dark' : 'light');
        docEl.setAttribute('data-bs-theme', theme);
        docEl.style.colorScheme = theme === 'dark' ? 'dark' : 'light';
      } catch (err) {
        docEl.setAttribute('data-bs-theme', 'light');
        docEl.style.colorScheme = 'light';
      }
    })();
  </script>
  <!-- 引入 Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
  <link href="{{ url_for('static', filename='css/site.css') }}" rel="stylesheet">
  <link href="{{ url_for('static', filename='css/media_gallery.css') }}" rel="stylesheet">
  <style>
    .rich-text-content {
      white-space: pre-wrap;
      word-break: break-word;
      line-height: 1.6;
    }
    .rich-text-content .link-chip,
    .rich-text-content .tag-chip,
    .rich-text-content .mention-chip,
    .rich-text-content .sentiment-chip {
      display: inline-flex;
      align-items: center;
      padding: 0.1rem 0.45rem;
      border-radius: 999px;
      font-size: 0.85em;
      margin-right: 0.3rem;
      margin-bottom: 0.3rem;
    }
    .rich-text-content .link-chip {
      background-color: var(--chip-link-bg);
      color: var(--bs-primary);
      border: 1px solid var(--chip-link-border);
      text-decoration: none;
    }
    .rich-text-content .link-chip:hover {
      background-color: var(--chip-link-hover-bg);
    }
    .rich-text-content .tag-chip {
      background-color: var(--chip-tag-bg);
      color: var(--chip-tag-color);
      border: 1px solid var(--chip-tag-border);
    }
    .rich-text-content .mention-chip {
      background-color: var(--chip-mention-bg);
      color: var(--chip-mention-color);
      border: 1px solid var(--chip-mention-border);
      text-decoration: none;
    }
    .rich-text-content .mention-chip:hover {
      background-color: var(--chip-mention-hover-bg);
    }
    .rich-text-content .sentiment-chip {
      background-color: var(--chip-sentiment-neutral-bg);
      border: 1px solid var(--chip-sentiment-neutral-border);
      color: var(--chip-sentiment-neutral-color);
      font-weight: 600;
    }
    .rich-text-content .sentiment-chip.sentiment-good {
      background-color: var(--chip-sentiment-good-bg);
      border-color: var(--chip-sentiment-good-border);
      color: var(--chip-sentiment-good-color);
    }
    .rich-text-content .sentiment-chip.sentiment-doubt {
      background-color: var(--chip-sentiment-doubt-bg);
      border-color: var(--chip-sentiment-doubt-border);
      color: var(--chip-sentiment-doubt-color);
    }
  </style>
</head>
<body class="page-body">
  <!-- 导航栏 -->
  <nav class="navbar navbar-expand-lg navbar-dark navbar-rainbow">
    <div class="container-fluid">
      <a class="navbar-brand" href="{{ url_for('index') }}">
        <img src="{{ url_for('static', filename='logo.png') }}"
             alt="Friendship Community 徽标"
             class="brand-logo"
             width="44"
             height="44"
             loading="lazy">
        <span class="brand-text">
          <span class="brand-title">OpenMind Hub</span>
          <span class="brand-tagline">FriendsLoveFun|NoBorders</span>
        </span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          {% if current_user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('items') }}">社区资源</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('locations_list') }}">空间地图</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('events_overview') }}">活动日程</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('members_list') }}">社区伙伴</a>
          </li>
          {% endif %}
        </ul>
        <ul class="navbar-nav ms-auto">
          {% if current_user.is_authenticated %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="userMenu" role="button" data-bs-toggle="dropdown">
              {{ current_user.name or current_user.username }}
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenu">
              <li><a class="dropdown-item" href="{{ url_for('edit_profile', member_id=current_user.id) }}">编辑个人信息</a></li>
              <li><a class="dropdown-item" href="http://blog.00ling.com" target="_blank" rel="noopener">作者个人博客</a></li>
              <li><a class="dropdown-item" href="https://github.com/Benjaminisgood/Benlab" target="_blank" rel="noopener">GitHub 源码</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="{{ url_for('logout') }}">退出</a></li>
            </ul>
          </li>
          {% else %}
          <li class="nav-item"><a class="nav-link" href="{{ url_for('login') }}">登录</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('register') }}">注册</a></li>
          {% endif %}
        </ul>
        <div class="d-flex align-items-center gap-3 theme-controls">
          <button class="btn btn-sm btn-theme-switch" type="button" data-theme-toggle aria-pressed="false">
            <span class="theme-switch-track" aria-hidden="true">
              <span class="theme-switch-thumb"></span>
            </span>
            <span class="theme-switch-label" data-theme-label>浅色模式</span>
          </button>
        </div>
      </div>
    </div>
  </nav>
  <main class="page-shell">
    <!-- 提示消息 -->
    <div class="container alert-stack">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, msg in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ msg }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>
    <!-- 主内容 -->
    <section class="page-content container">
      {% block content %}{% endblock %}
    </section>
  </main>

  <!-- 引入 Bootstrap JS (含 Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    window.BenlabUploadConfig = {{ (direct_upload_config or {'enabled': False}) | tojson }};
  </script>
  <script>
    (function () {
      var STORAGE_KEY = 'benlab-theme';
      var root = document.documentElement;
      var toggleBtn = document.querySelector('[data-theme-toggle]');
      var toggleLabel = toggleBtn ? toggleBtn.querySelector('[data-theme-label]') : null;
      var mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');

      function setToggleState(theme) {
        if (!toggleBtn) {
          return;
        }
        var isDark = theme === 'dark';
        toggleBtn.setAttribute('aria-pressed', isDark);
        toggleBtn.setAttribute('data-theme-state', theme);
        if (toggleLabel) {
          toggleLabel.textContent = isDark ? '深色模式' : '浅色模式';
        }
      }

      function applyTheme(theme, options) {
        if (!theme) {
          return;
        }
        var opts = options || {};
        var isChanged = root.getAttribute('data-bs-theme') !== theme;
        root.setAttribute('data-bs-theme', theme);
        root.style.colorScheme = theme === 'dark' ? 'dark' : 'light';
        setToggleState(theme);
        if (opts.persist) {
          try {
            window.localStorage.setItem(STORAGE_KEY, theme);
          } catch (err) {
            /* ignore */
          }
        }
        if (isChanged && !opts.silent) {
          window.dispatchEvent(new CustomEvent('benlab:themechange', { detail: { theme: theme } }));
        }
      }

      function currentTheme() {
        return (root.getAttribute('data-bs-theme') === 'dark') ? 'dark' : 'light';
      }

      var stored = null;
      try {
        stored = window.localStorage.getItem(STORAGE_KEY);
      } catch (err) {
        stored = null;
      }
      var initial = root.getAttribute('data-bs-theme') || stored || (mediaQuery.matches ? 'dark' : 'light');
      applyTheme(initial, { persist: false, silent: true });

      toggleBtn && toggleBtn.addEventListener('click', function () {
        var next = currentTheme() === 'dark' ? 'light' : 'dark';
        applyTheme(next, { persist: true });
      });

      var mediaListener = function (event) {
        var hasStoredPreference = false;
        try {
          hasStoredPreference = Boolean(window.localStorage.getItem(STORAGE_KEY));
        } catch (err) {
          hasStoredPreference = false;
        }
        if (!hasStoredPreference) {
          applyTheme(event.matches ? 'dark' : 'light', { persist: false });
        }
      };

      if (mediaQuery.addEventListener) {
        mediaQuery.addEventListener('change', mediaListener);
      } else if (mediaQuery.addListener) {
        mediaQuery.addListener(mediaListener);
      }
    })();
  </script>
  <script src="{{ url_for('static', filename='js/direct_upload.js') }}" defer></script>
  <!-- 启用 Bootstrap 工具提示（如需） -->
  <script>
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  </script>
  <script>
    window.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.modal').forEach(function (modal) {
        if (modal.parentElement !== document.body) {
          document.body.appendChild(modal);
        }
      });
    });
  </script>
  <script src="{{ url_for('static', filename='js/media_gallery.js') }}" defer></script>
</body>
</html>
