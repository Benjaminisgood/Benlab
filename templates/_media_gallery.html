{% macro render_media_gallery(entries, gallery_id, media_kind_labels, empty_text='暂无媒体文件', options=None) -%}
  {% set opts = options or {} %}
  {% set focus_overlay_id = (gallery_id|string) ~ '-focus-overlay' %}
  {% set gallery_class = opts.get('gallery_class') or 'media-gallery' %}
  {% set grid_class = opts.get('grid_class') or 'media-gallery-grid' %}
  {% set card_class = opts.get('card_class') or 'media-card' %}
  {% set card_extra_class = opts.get('card_extra_class') or '' %}
  {% set enable_focus_mode_opt = opts.get('enable_focus_mode') %}
  {% if enable_focus_mode_opt is none %}
    {% set enable_focus_mode_opt = opts.get('enable_fullscreen') %}
  {% endif %}
  {% set enable_focus_mode = enable_focus_mode_opt if enable_focus_mode_opt is not none else true %}
  {% set card_image_sizes = opts.get('card_image_sizes') or '(max-width: 576px) 92vw, (max-width: 992px) 45vw, 320px' %}
  {% set focus_image_sizes = opts.get('focus_image_sizes') or '100vw' %}
  {% set layout = opts.get('layout') or 'grid' %}
  {% set is_carousel = layout == 'carousel' %}
  {% set initial_visible_opt = opts.get('initial_visible') %}
  {% set initial_visible = (initial_visible_opt if initial_visible_opt is not none else 6)|int %}
  {% set entry_count = entries|length if entries else 0 %}
  {% set first_entry = entries[0] if entry_count > 0 else none %}
  {% set audio_entries = [] %}
  {% set should_collapse = entry_count > initial_visible %}
  {% set show_collapse = should_collapse and not is_carousel %}
  {% set oss_entries = entries | selectattr('source', 'equalto', 'oss') | list if entries else [] %}
  {% set has_oss_entries = oss_entries|length > 0 %}
  {% if entry_count %}
    {% set audio_entries = entries | selectattr('kind', 'equalto', 'audio') | list %}
  {% endif %}
  {% if entries %}
  <div class="{{ gallery_class }}{% if is_carousel %} media-gallery--carousel{% endif %}" id="{{ gallery_id }}" data-initial-visible="{{ initial_visible }}" data-total-count="{{ entry_count }}">
    {% if (enable_focus_mode and entry_count) or show_collapse or has_oss_entries %}
    <div class="media-gallery-toolbar">
      <div class="media-gallery-hints">
        {% if enable_focus_mode and entry_count %}
        <span class="media-gallery-hint text-muted">点击媒体进入专注欣赏，双击退出</span>
        {% endif %}
        {% if has_oss_entries %}
        <span class="media-gallery-hint text-warning">当前媒体来自 OSS，加载将消耗流量</span>
        {% endif %}
      </div>
      <div class="media-gallery-actions">
        {% if show_collapse %}
        <button class="btn btn-outline-secondary btn-sm"
                type="button"
                data-action="toggle-media-collapse"
                data-target="#{{ gallery_id }}"
                data-collapsed-text="展开全部 {{ entry_count }} 个媒体"
                data-expanded-text="收起部分媒体">
          展开全部 {{ entry_count }} 个媒体
        </button>
        {% endif %}
      </div>
    </div>
    {% endif %}
    {% if is_carousel %}
    <div class="media-carousel" data-role="media-carousel" data-initial-index="0">
      <div class="media-carousel-stage">
        <button type="button"
                class="media-focus-nav media-focus-nav-prev media-carousel-nav media-carousel-nav-prev"
                data-action="carousel-nav"
                data-direction="-1"
                {% if entry_count <= 1 %}disabled{% endif %}
                aria-label="上一条">
          &lsaquo;
        </button>
        <div class="media-focus-track" data-role="focus-track">
          <div class="media-focus-track-inner" data-role="focus-track-inner" style="--media-slide-count: {{ entry_count }}">
            {% for media in entries %}
            {% set kind = media.kind|default('file') %}
            {% set orientation = media.orientation if media.orientation is defined and media.orientation else 'unknown' %}
            <article class="media-focus-slide{% if loop.first %} is-active{% endif %}"
                     data-focus-slide
                     data-index="{{ loop.index0 }}"
                     data-title="{{ (media.display_name or media_kind_labels.get(kind, '媒体'))|e }}"
                     data-description="{{ (media.description or '')|e }}"
                     data-kind="{{ kind }}"
                     data-orientation="{{ orientation }}"
                     data-download="{{ media.url|e }}"
                     aria-hidden="{{ 'false' if loop.first else 'true' }}">
              <figure class="media-focus-figure"
                      {% if enable_focus_mode %}
                      role="button"
                      tabindex="0"
                      data-action="open-focus-mode"
                      data-focus-target="{{ focus_overlay_id }}"
                      data-focus-index="{{ loop.index0 }}"
                      aria-label="打开{{ (media.display_name or media_kind_labels.get(kind, '媒体'))|e }}的大图浏览"
                      {% endif %}>
                {% if kind == 'image' %}
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
                     data-lazy-src="{{ media.url|e }}"
                     alt="{{ (media.display_name or media_kind_labels.get('image', '图片'))|e }}"
                     class="media-focus-image"
                     data-orientation="{{ orientation }}"
                     sizes="{{ focus_image_sizes }}"
                     loading="lazy"
                     decoding="async">
                {% elif kind == 'video' %}
                <video class="media-focus-video"
                       controls
                       playsinline
                       preload="none"
                       data-lazy-preload="metadata"
                       data-lazy-poster="{{ media.poster|default('')|e }}">
                  <source data-lazy-src="{{ media.url|e }}" type="{{ media.mimetype or 'video/mp4' }}">
                  您的浏览器不支持视频播放。
                </video>
                {% elif kind == 'audio' %}
                <div class="media-focus-audio-inline">
                  <audio controls preload="none" data-lazy-preload="metadata">
                    <source data-lazy-src="{{ media.url|e }}" type="{{ media.mimetype or 'audio/mpeg' }}">
                    您的浏览器不支持音频播放。
                  </audio>
                </div>
                {% else %}
                <div class="media-focus-file">
                  <span class="media-focus-file-label">{{ media_kind_labels.get(kind, '文件') }}</span>
                  <a href="{{ media.url|e }}"
                     class="btn btn-primary btn-sm"
                     target="_blank"
                     rel="noopener"
                     aria-label="打开{{ (media.display_name or media_kind_labels.get(kind, '文件'))|e }}">
                    打开
                  </a>
                </div>
                {% endif %}
              </figure>
            </article>
            {% endfor %}
          </div>
        </div>
        <button type="button"
                class="media-focus-nav media-focus-nav-next media-carousel-nav media-carousel-nav-next"
                data-action="carousel-nav"
                data-direction="1"
                {% if entry_count <= 1 %}disabled{% endif %}
                aria-label="下一条">
          &rsaquo;
        </button>
      </div>
      <div class="media-focus-info">
        <div class="media-focus-counter" data-role="focus-counter">1/{{ entry_count }}</div>
        <div class="media-focus-caption" data-role="focus-caption">
          {% if first_entry %}
            {{ first_entry.description or (first_entry.display_name or media_kind_labels.get(first_entry.kind|default('file'), '媒体')) }}
          {% endif %}
        </div>
      </div>
    </div>
    {% else %}
    <div class="{{ grid_class }}" data-role="media-grid">
      {% for media in entries %}
      {% set kind = media.kind|default('file') %}
      {% set orientation = media.orientation if media.orientation is defined and media.orientation else 'unknown' %}
      {% set is_collapsed = should_collapse and loop.index > initial_visible %}
      <div class="{{ card_class }}{% if card_extra_class %} {{ card_extra_class }}{% endif %}"
           data-kind="{{ kind }}"
           data-orientation="{{ orientation }}"
           {% if is_collapsed %}data-collapsed="true" hidden aria-hidden="true"{% endif %}
           {% if enable_focus_mode %}
           role="button"
           tabindex="0"
           data-action="open-focus-mode"
           data-focus-target="{{ focus_overlay_id }}"
           data-focus-index="{{ loop.index0 }}"
           aria-label="打开{{ (media.display_name or media_kind_labels.get(kind, '媒体'))|e }}的大图浏览"
           {% endif %}>
        <div class="media-card-meta">
          <span class="media-kind-chip media-kind-chip-{{ kind }}">{{ media_kind_labels.get(kind, '媒体') }}</span>
          {% if enable_focus_mode %}
          <button class="media-card-focus-btn" type="button" aria-label="进入专注模式"
                  data-action="open-focus-mode"
                  data-focus-target="{{ focus_overlay_id }}"
                  data-focus-index="{{ loop.index0 }}">
            专注
          </button>
          {% endif %}
        </div>
        <div class="media-card-media"
             {% if enable_focus_mode %}
             data-action="open-focus-mode"
             data-focus-target="{{ focus_overlay_id }}"
             data-focus-index="{{ loop.index0 }}"
             aria-label="打开{{ (media.display_name or media_kind_labels.get(kind, '媒体'))|e }}的大图浏览"
             {% endif %}>
        {% if kind == 'image' %}
        <figure class="media-card-figure"
                {% if enable_focus_mode %}
                data-action="open-focus-mode"
                data-focus-target="{{ focus_overlay_id }}"
                data-focus-index="{{ loop.index0 }}"
                {% endif %}>
          <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
               data-lazy-src="{{ media.url }}"
               alt="{{ (media.display_name or '媒体文件')|e }}"
               class="media-card-img"
               data-orientation="{{ orientation }}"
               sizes="{{ card_image_sizes }}"
               loading="lazy"
               decoding="async">
        </figure>
        {% if media.description %}
        <p class="media-description">{{ media.description }}</p>
        {% endif %}
        {% elif kind == 'video' %}
        <figure class="media-card-figure"
                {% if enable_focus_mode %}
                data-action="open-focus-mode"
                data-focus-target="{{ focus_overlay_id }}"
                data-focus-index="{{ loop.index0 }}"
                {% endif %}>
          <video class="media-card-video"
                 muted
                 playsinline
                 controls
                 preload="none"
                 data-lazy-preload="metadata"
                 data-lazy-poster="{{ media.poster|default('') }}"
                 aria-label="{{ (media.display_name or media_kind_labels.get('video', '视频'))|e }}">
            <source data-lazy-src="{{ media.url|e }}" type="{{ media.mimetype or 'video/mp4' }}">
            您的浏览器不支持视频播放。
          </video>
        </figure>
        {% elif kind == 'audio' %}
        <figure class="media-card-figure media-card-audio-figure"
                {% if enable_focus_mode %}
                data-action="open-focus-mode"
                data-focus-target="{{ focus_overlay_id }}"
                data-focus-index="{{ loop.index0 }}"
                {% endif %}>
          <audio class="media-card-audio"
                 controls
                 preload="none"
                 data-lazy-preload="metadata"
                 aria-label="{{ (media.display_name or media_kind_labels.get('audio', '音频'))|e }}">
            <source data-lazy-src="{{ media.url|e }}" type="{{ media.mimetype or 'audio/mpeg' }}">
            您的浏览器不支持音频播放。
          </audio>
        </figure>
        {% else %}
        <div class="media-file-link">
          <span class="media-tag">{{ media_kind_labels.get(kind, '文件') }}</span>
        </div>
        {% endif %}
        </div>
        {% if media.description %}
        <p class="media-description">{{ media.description }}</p>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% if enable_focus_mode and entry_count %}
  <div class="media-focus-overlay" id="{{ focus_overlay_id }}" hidden tabindex="-1" aria-hidden="true">
    <div class="media-focus-backdrop" data-action="close-focus-mode"></div>
    <div class="media-focus-stage" role="dialog" aria-modal="true" aria-label="专注模式媒体浏览">
      <div class="media-focus-content">
        <button type="button"
                class="media-focus-nav media-focus-nav-prev"
                data-action="focus-nav"
                data-direction="-1"
                {% if entry_count <= 1 %}disabled{% endif %}
                aria-label="上一条">
          &lsaquo;
        </button>
        <div class="media-focus-track" data-role="focus-track">
          <div class="media-focus-track-inner" data-role="focus-track-inner" style="--media-slide-count: {{ entry_count }}">
            {% for media in entries %}
            {% set kind = media.kind|default('file') %}
            {% set orientation = media.orientation if media.orientation is defined and media.orientation else 'unknown' %}
            <article class="media-focus-slide{% if loop.first %} is-active{% endif %}"
                     data-focus-slide
                     data-index="{{ loop.index0 }}"
                     data-title="{{ (media.display_name or media_kind_labels.get(kind, '媒体'))|e }}"
                     data-description="{{ (media.description or '')|e }}"
                     data-kind="{{ kind }}"
                     data-orientation="{{ orientation }}"
                     data-download="{{ media.url|e }}"
                     aria-hidden="{{ 'false' if loop.first else 'true' }}">
              <figure class="media-focus-figure">
                {% if kind == 'image' %}
                <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
                     data-lazy-src="{{ media.url|e }}"
                     alt="{{ (media.display_name or media_kind_labels.get('image', '图片'))|e }}"
                     class="media-focus-image"
                     data-orientation="{{ orientation }}"
                     sizes="{{ focus_image_sizes }}"
                     loading="lazy"
                     decoding="async">
                {% elif kind == 'video' %}
                <video class="media-focus-video"
                       controls
                       playsinline
                       preload="none"
                       data-lazy-preload="metadata"
                       data-lazy-poster="{{ media.poster|default('')|e }}">
                  <source data-lazy-src="{{ media.url|e }}" type="{{ media.mimetype or 'video/mp4' }}">
                  您的浏览器不支持视频播放。
                </video>
                {% elif kind == 'audio' %}
                <div class="media-focus-audio-inline">
                  <audio controls preload="none" data-lazy-preload="metadata">
                    <source data-lazy-src="{{ media.url|e }}" type="{{ media.mimetype or 'audio/mpeg' }}">
                    您的浏览器不支持音频播放。
                  </audio>
                </div>
                {% else %}
                <div class="media-focus-file">
                  <span class="media-focus-file-label">{{ media_kind_labels.get(kind, '文件') }}</span>
                  <a href="{{ media.url|e }}"
                     class="btn btn-primary btn-sm"
                     target="_blank"
                     rel="noopener"
                     aria-label="打开{{ (media.display_name or media_kind_labels.get(kind, '文件'))|e }}">
                    打开
                  </a>
                </div>
                {% endif %}
              </figure>
            </article>
            {% endfor %}
          </div>
        </div>
        <button type="button"
                class="media-focus-nav media-focus-nav-next"
                data-action="focus-nav"
                data-direction="1"
                {% if entry_count <= 1 %}disabled{% endif %}
                aria-label="下一条">
          &rsaquo;
        </button>
      </div>
      <div class="media-focus-info">
        <div class="media-focus-counter" data-role="focus-counter">1/{{ entry_count }}</div>
        <div class="media-focus-caption" data-role="focus-caption">
          {% if first_entry %}
            {{ first_entry.description or (first_entry.display_name or media_kind_labels.get(first_entry.kind|default('file'), '媒体')) }}
          {% endif %}
        </div>
      </div>
      {% if audio_entries %}
      <div class="media-focus-audio-panel" data-role="focus-audio-panel">
        <label for="{{ focus_overlay_id }}-audio-select" class="form-label mb-0">背景音乐</label>
        <div class="media-focus-audio-controls">
          <select class="form-select form-select-sm media-focus-audio-select"
                  id="{{ focus_overlay_id }}-audio-select"
                  data-role="focus-audio-select"
                  aria-label="切换背景音乐">
            {% for audio in audio_entries %}
            <option value="{{ loop.index0 }}" data-src="{{ audio.url|e }}">
              {{ audio.display_name or media_kind_labels.get('audio', '音频') }}
            </option>
            {% endfor %}
          </select>
          <audio class="media-focus-audio-player"
                 data-role="focus-audio-player"
                 controls
                 preload="metadata"></audio>
        </div>
      </div>
      {% endif %}
      <div class="media-focus-action-sheet" data-role="focus-action-sheet" hidden>
        <div class="media-focus-action-card">
          <p class="mb-2 text-muted small">长按已激活更多动作</p>
          <a class="btn btn-light btn-sm w-100"
             data-role="focus-download-link"
             href="#"
             download>
            下载当前媒体
          </a>
          <button type="button"
                  class="btn btn-outline-light btn-sm w-100 mt-2"
                  data-action="focus-action-close">
            收起
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="media-empty text-muted">
    <p class="mb-0">{{ empty_text }}</p>
  </div>
  {% endif %}
  <script>
    (function () {
      var gallery = document.getElementById('{{ gallery_id }}');
      if (!gallery) return;
      gallery.addEventListener('click', function (event) {
        var trigger = event.target.closest('[data-action="open-focus-mode"][data-focus-target]');
        if (!trigger) return;
        event.preventDefault();
        if (window.BenlabOpenFocus) {
          window.BenlabOpenFocus(trigger);
        }
      });
    })();
  </script>
{%- endmacro %}
