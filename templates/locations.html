{% extends "base.html" %}
{% block content %}

{% macro render_location(loc, level=0) %}
<tr class="{% if level == 0 %}table-primary{% else %}table-light{% endif %} indent-{{ level }}">
  <td>
    {% if level > 0 %}↳ {% endif %}
    <a href="{{ url_for('view_location', loc_id=loc.id) }}">{{ loc.name }}</a>
  </td>
  <td>
    {% if loc.responsible_members and loc.responsible_members|length > 0 %}
      {%- for member in loc.responsible_members %}
        <a href="{{ url_for('profile', member_id=member.id) }}">{{ member.name }}</a>{% if not loop.last %}，{% endif %}
      {%- endfor %}
    {% else %}
      -
    {% endif %}
  </td>
  <td>{{ loc.items|length }}</td>
  <td>
    <a href="{{ url_for('edit_location', loc_id=loc.id) }}" class="btn btn-sm btn-outline-primary">编辑</a>
    <form action="{{ url_for('delete_location', loc_id=loc.id) }}" method="post" class="d-inline" onsubmit="return confirm('确定删除该位置吗？');">
      <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
    </form>
  </td>
</tr>

{# 递归渲染所有子节点 #}
{% for child in loc.children|sort(attribute='name') %}
  {{ render_location(child, level + 1) }}
{% endfor %}
{% endmacro %}

<h3 class="mb-3">实验室位置列表</h3>
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3 gap-2">
  <div class="flex-grow-1 position-relative">
    <input type="text" id="filterInput" class="form-control" placeholder="按位置名称筛选 / 导航">
    <div id="locationsSuggestions" class="list-group position-absolute w-100 shadow-sm d-none" style="z-index: 20;"></div>
  </div>
  <a href="{{ url_for('add_location') }}" class="btn btn-primary flex-shrink-0">新增位置</a>
</div>
<table class="table table-hover" id="locationsTable">
  <thead class="table-light">
    <tr>
      <th>名称</th>
      <th>负责人</th>
      <th>包含物品数量</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    {% for loc in locations if not loc.parent_id %}
      {{ render_location(loc) }}
    {% endfor %}
    {% if locations|length == 0 %}
    <tr>
      <td colspan="4" class="text-center text-muted">暂无位置记录</td>
    </tr>
    {% endif %}
  </tbody>
</table>

<style>
  .indent-1 td { padding-left: 2rem; background-color: #f8f9fa; }
  .indent-2 td { padding-left: 3rem; background-color: #f1f3f5; }
  .indent-3 td { padding-left: 4rem; background-color: #e9ecef; }
  .indent-4 td { padding-left: 5rem; background-color: #dee2e6; }
  .indent-5 td { padding-left: 6rem; background-color: #ced4da; }
  #locationsSuggestions a { text-decoration: none; }
</style>

<script>
  (function () {
    const input = document.getElementById('filterInput');
    const tableRows = document.querySelectorAll('#locationsTable tbody tr');
    const suggestionBox = document.getElementById('locationsSuggestions');
    let debounceTimer = null;
    let currentAbort = null;

    function filterTable(value) {
      const filterValue = value.toLowerCase();
      tableRows.forEach(row => {
        const nameCell = row.querySelector('td:first-child a');
        if (!nameCell) {
          return;
        }
        const text = nameCell.textContent.toLowerCase();
        row.style.display = text.includes(filterValue) ? '' : 'none';
      });
    }

    async function updateSuggestions(value) {
      if (!suggestionBox) {
        return;
      }
      const trimmed = value.trim();
      if (currentAbort) {
        currentAbort.abort();
        currentAbort = null;
      }
      if (!trimmed) {
        suggestionBox.classList.add('d-none');
        suggestionBox.innerHTML = '';
        return;
      }
      const abortController = new AbortController();
      currentAbort = abortController;
      try {
        const resp = await fetch(`{{ url_for('search_locations') }}?q=${encodeURIComponent(trimmed)}`, { signal: abortController.signal });
        if (!resp.ok) {
          throw new Error('Search failed');
        }
        const data = await resp.json();
        suggestionBox.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          suggestionBox.classList.add('d-none');
          return;
        }
        data.forEach(entry => {
          const row = document.createElement('div');
          row.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          const nameWrap = document.createElement('div');
          nameWrap.className = 'flex-grow-1';
          nameWrap.textContent = entry.name;
          row.appendChild(nameWrap);
          if (entry.hasCoordinates && typeof entry.latitude === 'number' && typeof entry.longitude === 'number') {
            const navLink = document.createElement('a');
            navLink.className = 'btn btn-sm btn-outline-primary ms-3';
            const lat = Number(entry.latitude).toFixed(6);
            const lng = Number(entry.longitude).toFixed(6);
            navLink.href = `geo:${lat},${lng}`;
            navLink.textContent = '导航';
            navLink.addEventListener('click', ev => ev.stopPropagation());
            row.appendChild(navLink);
          }
          row.addEventListener('click', () => {
            window.location.href = entry.detailUrl;
          });
          suggestionBox.appendChild(row);
        });
        suggestionBox.classList.remove('d-none');
      } catch (err) {
        if (err.name !== 'AbortError') {
          suggestionBox.classList.add('d-none');
        }
      }
    }

    if (input) {
      input.addEventListener('input', function () {
        const value = this.value;
        filterTable(value);
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => updateSuggestions(value), 200);
      });
      input.addEventListener('focus', function () {
        if (this.value.trim()) {
          updateSuggestions(this.value);
        }
      });
      input.addEventListener('blur', function () {
        setTimeout(() => {
          if (suggestionBox) {
            suggestionBox.classList.add('d-none');
          }
        }, 150);
      });
    }
  })();
</script>

{% endblock %}
