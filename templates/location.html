{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">{{ location.name }}</h4>
<p>负责人:
  {% if location.responsible_member %}
    <a href="{{ url_for('profile', member_id=location.responsible_member.id) }}">{{ location.responsible_member.name }}</a>
  {% else %} 无 {% endif %}
  {% if location.notes %}
  <br><small class="text-muted">{{ location.notes }}</small>
  {% endif %}
</p>
{% if location.image %}
  <div class="mb-3">
    <div class="position-relative border" style="display: inline-block;">
      <img id="locationImg" src="{{ url_for('static', filename='images/' + location.image) }}" alt="{{ location.name }}" class="img-fluid">
      {% for it in items %}
        {% if it.pos_x is not none and it.pos_y is not none %}
        <a href="{{ url_for('item_detail', item_id=it.id) }}" class="pin-icon" style="left: {{ it.pos_x }}%; top: {{ it.pos_y }}%;" title="{{ it.name }}">📌</a>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% set items_no_pos = items|selectattr("pos_x", "==", none) | list %}
  {% if items_no_pos %}
  <form method="post" action="{{ url_for('set_item_position', loc_id=location.id) }}" class="mb-4">
    <div class="row align-items-center">
      <div class="col-auto">
        <label for="itemSelect" class="form-label mb-0">将物品标记在图中:</label>
      </div>
      <div class="col-auto">
        <select id="itemSelect" name="item_id" class="form-select">
          {% for it in items_no_pos %}
          <option value="{{ it.id }}">{{ it.name }}</option>
          {% endfor %}
        </select>
      </div>
      <input type="hidden" name="pos_x" id="posX">
      <input type="hidden" name="pos_y" id="posY">
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">保存位置</button>
      </div>
      <div class="col-12">
        <small class="text-muted">点击上方图片选择位置，然后点击保存</small>
      </div>
    </div>
  </form>
  <script>
    // 点击图片获取坐标脚本
    const locImg = document.getElementById('locationImg');
    if(locImg) {
      locImg.addEventListener('click', function(e) {
        const rect = locImg.getBoundingClientRect();
        const xPercent = ((e.clientX - rect.left) / rect.width) * 100;
        const yPercent = ((e.clientY - rect.top) / rect.height) * 100;
        const posXInput = document.getElementById('posX');
        const posYInput = document.getElementById('posY');
        if(posXInput && posYInput) {
          posXInput.value = xPercent.toFixed(2);
          posYInput.value = yPercent.toFixed(2);
        }
      });
    }
  </script>
  {% endif %}
{% else %}
  <p class="text-muted">无图片</p>
{% endif %}
<h5 class="mt-4">包含的物品</h5>
<ul class="list-group">
  {% for it in items %}
    <li class="list-group-item">
      {% if it.pos_x is not none and it.pos_y is not none %}📌 {% endif %}
      <a href="{{ url_for('item_detail', item_id=it.id) }}">{{ it.name }}</a>
      {% if it.status %}<span class="badge bg-secondary">{{ it.status }}</span>{% endif %}
      {% if it.responsible_member %}<small class="text-muted"> - {{ it.responsible_member.name }}</small>{% endif %}
    </li>
  {% else %}
    <li class="list-group-item text-muted">（此位置暂无物品）</li>
  {% endfor %}
</ul>
{% endblock %}