{% extends "base.html" %}
{% block content %}

{% macro render_location(loc, level=0) %}
{% set usage_tags = loc.usage_tags %}
{% set status = normalize_location_status(loc.status) %}
{% set status_intent = location_status_intent(status) %}
{% set is_dirty = is_location_dirty(status) %}
{% set ownership_tone = 'public' if loc.is_public else 'private' %}
{% set ownership_label = '公共' if loc.is_public else '私人' %}
{% set usage_labels = [] %}
{% for tag in usage_tags %}
  {% set _ = usage_labels.append(location_usage_labels.get(tag, tag)) %}
{% endfor %}
{% set responsible_labels = [] %}
{% for member in loc.responsible_members %}
  {% set _ = responsible_labels.append(member.name or member.username) %}
{% endfor %}
{% set search_blob = loc.name ~ ' ' ~ ownership_label ~ ' ' ~ (status or '-') ~ ' ' ~ (usage_labels|join(' ')) ~ ' ' ~ (responsible_labels|join(' ')) %}
<tr class="indent-{{ level }}{% if level == 0 %} location-row-root{% endif %}{% if is_dirty %} location-row-critical{% endif %}" data-search="{{ search_blob|lower }}">
  <td class="col-location-name">
    <div class="d-flex align-items-center flex-wrap gap-2">
      {% if level > 0 %}<span class="text-muted">↳</span>{% endif %}
      <a href="{{ url_for('view_location', loc_id=loc.id) }}">{{ loc.name }}</a>
      <span class="badge badge-item-feature badge-item-feature-{{ ownership_tone }}">{{ ownership_label }}</span>
      {% if status %}
        <span class="badge {% if status_intent == 'critical' %}bg-danger{% elif status_intent == 'warning' %}bg-warning text-dark{% elif status_intent == 'positive' %}bg-success{% else %}bg-secondary{% endif %}">{{ status }}</span>
      {% endif %}
    </div>
  </td>
  <td class="col-location-usage">
    {% if usage_tags %}
      <div class="d-flex flex-wrap gap-1">
        {% for tag in usage_tags %}
          <span class="badge bg-light text-dark border">{{ location_usage_labels.get(tag, tag) }}</span>
        {% endfor %}
      </div>
    {% else %}
      <span class="text-muted">-</span>
    {% endif %}
  </td>
  <td class="col-location-responsible">
    <div class="d-flex flex-wrap align-items-center gap-2">
      <span class="badge badge-item-feature badge-item-feature-{{ ownership_tone }}">{{ ownership_label }}</span>
      {% if loc.responsible_members and loc.responsible_members|length > 0 %}
        <div class="d-flex flex-wrap align-items-center gap-2">
          {%- for member in loc.responsible_members %}
            <a href="{{ url_for('profile', member_id=member.id) }}">{{ member.name or member.username }}</a>{% if not loop.last %}，{% endif %}
          {%- endfor %}
        </div>
      {% elif loc.is_public %}
        <span class="text-muted">公共（社区共同维护）</span>
      {% else %}
        <span class="text-muted">-</span>
      {% endif %}
    </div>
  </td>
  <td class="col-location-actions text-nowrap text-end">
    <div class="d-flex flex-wrap justify-content-end gap-1">
      <a href="{{ url_for('edit_location', loc_id=loc.id) }}" class="btn btn-sm btn-outline-primary">编辑</a>
      <form action="{{ url_for('delete_location', loc_id=loc.id) }}" method="post" class="d-inline" onsubmit="return confirm('确定删除该空间吗？');">
        <button type="submit" class="btn btn-sm btn-outline-danger">删除</button>
      </form>
    </div>
  </td>
</tr>

{# 递归渲染所有子节点 #}
{% for child in loc.children|sort(attribute='name') %}
  {{ render_location(child, level + 1) }}
{% endfor %}
{% endmacro %}

<div class="d-flex justify-content-between align-items-center mb-3 page-header-actions">
  <h3 class="mb-0">社区空间总览</h3>
  <a href="{{ url_for('add_location') }}" class="btn btn-primary">新增空间</a>
</div>
<div class="position-relative mb-3">
  <input type="text" id="filterInput" class="form-control" placeholder="输入名称 / 用途 / 负责人 立即筛选">
  <div id="locationsSuggestions" class="list-group position-absolute w-100 shadow-sm d-none" style="z-index: 20;"></div>
</div>
<div class="table-responsive">
  <table class="table table-hover align-middle" id="locationsTable">
    <thead class="table-light">
      <tr>
        <th class="col-location-name">名称</th>
        <th class="col-location-usage">用途</th>
        <th class="col-location-responsible">负责人</th>
        <th class="col-location-actions text-end">操作</th>
      </tr>
    </thead>
    <tbody>
      {% for loc in locations if not loc.parent_id %}
        {{ render_location(loc) }}
      {% endfor %}
      <tr id="locationsNoResultRow" class="text-center text-muted {% if locations|length > 0 %}d-none{% endif %}">
        <td colspan="4">{{ '暂无空间记录' if locations|length == 0 else '没有找到空间' }}</td>
      </tr>
    </tbody>
  </table>
</div>

<style>
  .location-row-critical td {
    background-color: rgba(var(--bs-danger-rgb), 0.08) !important;
  }
  .location-row-critical td:first-child {
    box-shadow: inset 3px 0 0 rgba(var(--bs-danger-rgb), 0.7);
  }
  .indent-1 td { padding-left: 2rem; background-color: var(--location-indent-bg-1); }
  .indent-2 td { padding-left: 3rem; background-color: var(--location-indent-bg-2); }
  .indent-3 td { padding-left: 4rem; background-color: var(--location-indent-bg-3); }
  .indent-4 td { padding-left: 5rem; background-color: var(--location-indent-bg-4); }
  .indent-5 td { padding-left: 6rem; background-color: var(--location-indent-bg-5); }
  #locationsSuggestions a { text-decoration: none; }
</style>

<script>
  (function () {
    var input = document.getElementById('filterInput');
    var suggestionBox = document.getElementById('locationsSuggestions');
    var tableRows = Array.prototype.slice.call(document.querySelectorAll('#locationsTable tbody tr[data-search]'));
    var emptyRow = document.getElementById('locationsNoResultRow');
    var debounceTimer = null;
    var currentAbort = null;

    function applyFilter(value) {
      var normalized = value.trim().toLowerCase();
      var visibleCount = 0;
      tableRows.forEach(function (row) {
        if (!normalized) {
          row.classList.remove('d-none');
          visibleCount += 1;
          return;
        }
        var haystack = row.getAttribute('data-search') || '';
        if (haystack.indexOf(normalized) !== -1) {
          row.classList.remove('d-none');
          visibleCount += 1;
        } else {
          row.classList.add('d-none');
        }
      });
      if (emptyRow) {
        if (tableRows.length === 0) {
          emptyRow.classList.remove('d-none');
        } else {
          emptyRow.classList.toggle('d-none', visibleCount > 0);
        }
      }
    }

    async function updateSuggestions(value) {
      if (!suggestionBox) {
        return;
      }
      var trimmed = value.trim();
      if (currentAbort) {
        currentAbort.abort();
        currentAbort = null;
      }
      if (!trimmed) {
        suggestionBox.classList.add('d-none');
        suggestionBox.innerHTML = '';
        return;
      }
      var abortController = new AbortController();
      currentAbort = abortController;
      try {
        var resp = await fetch(`{{ url_for('search_locations') }}?q=${encodeURIComponent(trimmed)}`, { signal: abortController.signal });
        if (!resp.ok) {
          throw new Error('Search failed');
        }
        var data = await resp.json();
        suggestionBox.innerHTML = '';
        if (!Array.isArray(data) || data.length === 0) {
          suggestionBox.classList.add('d-none');
          return;
        }
        data.forEach(function (entry) {
          var row = document.createElement('div');
          row.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
          var nameWrap = document.createElement('div');
          nameWrap.className = 'flex-grow-1';
          nameWrap.textContent = entry.name;
          row.appendChild(nameWrap);
          if (entry.hasCoordinates && typeof entry.latitude === 'number' && typeof entry.longitude === 'number') {
            var navLink = document.createElement('a');
            navLink.className = 'btn btn-sm btn-outline-primary ms-3';
            var lat = Number(entry.latitude).toFixed(6);
            var lng = Number(entry.longitude).toFixed(6);
            navLink.href = `geo:${lat},${lng}`;
            navLink.textContent = '导航';
            navLink.addEventListener('click', function (ev) {
              ev.stopPropagation();
            });
            row.appendChild(navLink);
          }
          row.addEventListener('click', function () {
            window.location.href = entry.detailUrl;
          });
          suggestionBox.appendChild(row);
        });
        suggestionBox.classList.remove('d-none');
      } catch (err) {
        if (err.name !== 'AbortError') {
          suggestionBox.classList.add('d-none');
        }
      }
    }

    if (input) {
      input.addEventListener('input', function () {
        var value = this.value;
        applyFilter(value);
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(function () {
          updateSuggestions(value);
        }, 200);
      });
      input.addEventListener('focus', function () {
        if (this.value.trim()) {
          updateSuggestions(this.value);
        }
      });
      input.addEventListener('blur', function () {
        setTimeout(function () {
          if (suggestionBox) {
            suggestionBox.classList.add('d-none');
          }
        }, 150);
      });
    }
    applyFilter('');
  })();
</script>

{% endblock %}
