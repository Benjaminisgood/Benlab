{% extends "base.html" %}
{% block content %}
<style>
  .follow-toggle {
    background: none;
    border: none;
    padding: 0;
    margin-right: 0.5rem;
    cursor: pointer;
    line-height: 1;
  }
  .follow-toggle:disabled {
    cursor: wait;
    opacity: 0.6;
  }
  .follow-star {
    font-size: 1.1rem;
    color: #ced4da;
    transition: color 0.2s ease;
  }
  .follow-star.followed {
    color: #ffc107;
  }
  .identity-badge {
    display: inline-block;
    margin-right: 0.5rem;
  }
</style>

<h3 class="mb-3">课题组成员</h3>
<div class="position-relative mb-3">
  <input type="text" class="form-control" id="membersFilterInput" placeholder="输入姓名 / 用户名 / 联系方式即时筛选">
</div>
<table class="table table-hover align-middle" id="membersTable">
  <thead class="table-light">
    <tr><th>姓名</th><th>用户名</th><th>联系方式</th><th>负责物品数</th><th>负责位置数</th></tr>
  </thead>
  <tbody>
    {% for mem in members %}
    {% set items_count = mem.items|length %}
    {% set locations_count = mem.locations|length %}
    {% set search_blob = ((mem.name or mem.username) ~ ' ' ~ mem.username ~ ' ' ~ (mem.contact or '') ~ ' ' ~ items_count ~ ' ' ~ locations_count) %}
    <tr data-search="{{ search_blob|lower }}">
      <td>
        {% if mem.id == current_user.id %}
          <span class="badge bg-secondary identity-badge">我</span>
          <a href="{{ url_for('profile', member_id=mem.id) }}">{{ mem.name or mem.username }}</a>
        {% else %}
          <button class="follow-toggle" type="button" data-url="{{ url_for('toggle_follow', member_id=mem.id) }}" aria-label="关注或取消关注">
            <span class="follow-star{% if mem.id in followed_ids %} followed{% endif %}">
              {% if mem.id in followed_ids %}★{% else %}☆{% endif %}
            </span>
          </button>
          <a href="{{ url_for('profile', member_id=mem.id) }}">{{ mem.name or mem.username }}</a>
        {% endif %}
      </td>
      <td>{{ mem.username }}</td>
      <td>{{ mem.contact or '-' }}</td>
      <td>{{ mem.items|length }}</td>
      <td>{{ mem.locations|length }}</td>
    </tr>
    {% endfor %}
    <tr id="membersEmptyRow" class="text-center text-muted {% if members|length > 0 %}d-none{% endif %}">
      <td colspan="5">暂无成员</td>
    </tr>
  </tbody>
</table>

<script>
  document.querySelectorAll('.follow-toggle').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var url = btn.dataset.url;
      if (!url) {
        return;
      }
      btn.disabled = true;
      fetch(url, {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      }).then(function (response) {
        btn.disabled = false;
        if (!response.ok) {
          return response.json().catch(function () { return {}; }).then(function (data) {
            if (data.error) {
              alert(data.error);
            }
          });
        }
        return response.json().then(function (data) {
          var star = btn.querySelector('.follow-star');
          if (!star) {
            return;
          }
          if (data.followed) {
            star.classList.add('followed');
            star.textContent = '★';
          } else {
            star.classList.remove('followed');
            star.textContent = '☆';
          }
          setTimeout(function () {
            window.location.reload();
          }, 100);
        });
      }).catch(function () {
        btn.disabled = false;
      });
    });
  });

  (function () {
    var filterInput = document.getElementById('membersFilterInput');
    if (!filterInput) {
      return;
    }
    var rows = Array.prototype.slice.call(document.querySelectorAll('#membersTable tbody tr[data-search]'));
    var emptyRow = document.getElementById('membersEmptyRow');
    filterInput.addEventListener('input', function () {
      var keyword = (this.value || '').trim().toLowerCase();
      var visible = 0;
      rows.forEach(function (row) {
        var haystack = row.getAttribute('data-search') || '';
        var match = !keyword || haystack.indexOf(keyword) !== -1;
        if (match) {
          row.classList.remove('d-none');
          visible += 1;
        } else {
          row.classList.add('d-none');
        }
      });
      if (emptyRow) {
        var cell = emptyRow.querySelector('td');
        if (rows.length === 0) {
          emptyRow.classList.remove('d-none');
          if (cell) {
            cell.textContent = '暂无成员';
          }
          return;
        }
        if (visible === 0) {
          emptyRow.classList.remove('d-none');
          if (cell) {
            cell.textContent = '未找到匹配的成员';
          }
        } else {
          emptyRow.classList.add('d-none');
          if (cell) {
            cell.textContent = '暂无成员';
          }
        }
      }
    });
  })();
</script>
{% endblock %}
