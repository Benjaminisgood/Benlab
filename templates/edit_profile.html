{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">编辑个人信息</h4>
<form method="post" enctype="multipart/form-data" action="{{ url_for('edit_profile', member_id=member.id) }}">
  <div class="mb-3">
    <label for="name" class="form-label">姓名</label>
    <input type="text" class="form-control" id="name" name="name" value="{{ member.name }}" required>
  </div>
  <div class="mb-3">
    <label for="contact" class="form-label">联系方式</label>
    <input type="text" class="form-control" id="contact" name="contact" value="{{ member.contact or '' }}">
  </div>
  <div class="mb-3">
    <label for="bio" class="form-label">个人介绍</label>
    <textarea class="form-control" id="bio" name="bio" rows="3" placeholder="向社区伙伴介绍自己、最近关注的项目等">{{ profile_meta.bio }}</textarea>
    {% if not structured_notes and member.notes %}
      <div class="form-text text-muted">已为你预加载原有备注，保存后将转换为新格式。</div>
    {% endif %}
  </div>
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center">
      <label class="form-label mb-0">社交链接</label>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="addSocialLinkBtn">新增链接</button>
    </div>
    <div id="socialLinksContainer" class="d-flex flex-column gap-2 mt-2">
      {% if profile_meta.social_links %}
        {% for link in profile_meta.social_links %}
        <div class="input-group social-link-row">
          <span class="input-group-text">平台</span>
          <input type="text" class="form-control" name="social_label" value="{{ link.label }}" placeholder="例如：微博 / B站">
          <span class="input-group-text">地址</span>
          <input type="url" class="form-control" name="social_url" value="{{ link.url }}" placeholder="https://example.com/you">
          <button class="btn btn-outline-danger social-link-remove" type="button">&times;</button>
        </div>
        {% endfor %}
      {% else %}
        <div class="input-group social-link-row">
          <span class="input-group-text">平台</span>
          <input type="text" class="form-control" name="social_label" placeholder="例如：微博 / B站">
          <span class="input-group-text">地址</span>
          <input type="url" class="form-control" name="social_url" placeholder="https://example.com/you">
          <button class="btn btn-outline-danger social-link-remove" type="button">&times;</button>
        </div>
      {% endif %}
    </div>
    <div class="form-text">可添加多个链接，便于他人关注你的社交账号或作品主页。</div>
  </div>
  <div class="mb-3">
    <div class="d-flex justify-content-between align-items-center">
      <label class="form-label mb-0">地点关联</label>
      <button type="button" class="btn btn-sm btn-outline-secondary" id="addAffiliationBtn">新增关联</button>
    </div>
    <div id="affiliationsContainer" class="d-flex flex-column gap-3 mt-2">
      {% if profile_meta.location_relations %}
        {% for entry in profile_meta.location_relations %}
        {% set current_loc = (locations | selectattr('id','equalto', entry.location_id) | first) %}
        <div class="affiliation-row border rounded p-3" data-affiliation-index="{{ loop.index0 }}">
          <div class="row g-2 align-items-end">
            <div class="col-md-5">
              <label class="form-label d-block">地点</label>
              <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="badge bg-light text-dark border affiliation-location-summary" data-default="选择地点">
                  {{ current_loc.name if current_loc else '选择地点' }}
                </div>
                <button type="button"
                        class="btn btn-outline-secondary btn-sm affiliation-location-picker"
                        data-bs-toggle="modal"
                        data-bs-target="#affiliationLocationModal"
                        data-affiliation-index="{{ loop.index0 }}"
                        data-selected="{{ entry.location_id if entry.location_id else '' }}">
                  选择地点
                </button>
              </div>
              <input type="hidden" name="affiliation_location_id" value="{{ entry.location_id if entry.location_id else '' }}">
            </div>
            <div class="col-md-3 col-sm-6">
              <label class="form-label">关联关系</label>
              <select class="form-select" name="affiliation_relation">
                {% for key, label in relation_lookup.items() %}
                <option value="{{ key }}" {% if entry.relation == key %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-sm-6">
              <label class="form-label">备注</label>
              <input type="text" class="form-control" name="affiliation_note" value="{{ entry.note }}">
            </div>
            <div class="col-md-1 d-grid">
              <button type="button" class="btn btn-outline-danger affiliation-remove">&times;</button>
            </div>
          </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="affiliation-row border rounded p-3" data-affiliation-index="0">
      <div class="row g-2 align-items-end">
            <div class="col-md-5">
              <label class="form-label d-block">地点</label>
              <div class="d-flex flex-wrap align-items-center gap-2">
                <div class="badge bg-light text-dark border affiliation-location-summary" data-default="选择地点">
                  选择地点
                </div>
                <button type="button"
                        class="btn btn-outline-secondary btn-sm affiliation-location-picker"
                        data-bs-toggle="modal"
                        data-bs-target="#affiliationLocationModal"
                        data-affiliation-index="0"
                        data-selected="">
                  选择地点
                </button>
              </div>
              <input type="hidden" name="affiliation_location_id" value="">
            </div>
            <div class="col-md-3 col-sm-6">
              <label class="form-label">关联关系</label>
              <select class="form-select" name="affiliation_relation">
                {% for key, label in relation_lookup.items() %}
                <option value="{{ key }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3 col-sm-6">
              <label class="form-label">备注</label>
              <input type="text" class="form-control" name="affiliation_note" placeholder="选填：班级 / 部门等">
            </div>
            <div class="col-md-1 d-grid">
              <button type="button" class="btn btn-outline-danger affiliation-remove">&times;</button>
            </div>
      </div>
    </div>
  {% endif %}
</div>
<div class="form-text">说明你与地点的关系，例如“上学”“居住”“工作”等，帮助他人了解你与社区空间的联系。</div>

<div class="modal fade" id="affiliationLocationModal" tabindex="-1" aria-labelledby="affiliationLocationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="affiliationLocationModalLabel">选择关联地点</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
      </div>
      <div class="modal-body">
        <input type="search" class="form-control form-control-sm mb-3" id="affiliationLocationSearch" placeholder="搜索空间名称">
        <div class="border rounded p-2" style="max-height: 320px; overflow-y: auto;">
          <div class="form-check affiliation-location-row py-1" data-label="顶层空间">
            <input class="form-check-input affiliation-location-radio" type="radio" name="affiliation_location_select" value=""
                   id="affiliationLocationNone" data-name="选择地点">
            <label class="form-check-label" for="affiliationLocationNone">未指定</label>
          </div>
          {% for loc in locations %}
          <div class="form-check affiliation-location-row py-1" data-label="{{ loc.name|lower }}">
            <input class="form-check-input affiliation-location-radio" type="radio" name="affiliation_location_select"
                   value="{{ loc.id }}" id="affiliationLocation{{ loc.id }}" data-name="{{ loc.name }}">
            <label class="form-check-label" for="affiliationLocation{{ loc.id }}">{{ loc.name }}</label>
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="affiliationLocationClearBtn">清除选择</button>
        <button type="button" class="btn btn-primary btn-sm" id="affiliationLocationConfirmBtn" data-bs-dismiss="modal">完成</button>
      </div>
    </div>
  </div>
</div>
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">新密码 (留空则不修改)</label>
    <input type="password" class="form-control" id="password" name="password">
  </div>
  <div class="mb-3">
    <label for="photoInput" class="form-label">头像 (可选)</label>
    {% if member.photo %}
    <div class="mb-2">
      <img src="{{ uploaded_image_url(member.photo) }}" alt="头像" class="img-thumbnail" style="max-width:100px;">
    </div>
    {% endif %}
    <input type="file" id="photoInput" name="photo" accept="image/*" class="form-control">
    <img id="photoPreview" src="#" alt="预览" style="max-width: 100px; display: none; margin-top: 5px;">
  </div>
  <button type="submit" class="btn btn-success">保存</button>
  <a href="{{ url_for('profile', member_id=member.id) }}" class="btn btn-secondary">取消</a>
</form>
<script>
  // 头像预览脚本
  const photoInput = document.getElementById('photoInput');
  const photoPreview = document.getElementById('photoPreview');
  if(photoInput && photoPreview) {
    photoInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if(file) {
        photoPreview.src = URL.createObjectURL(file);
        photoPreview.style.display = 'block';
      } else {
        photoPreview.style.display = 'none';
      }
    });
  }
  (function manageSocialLinks() {
    const container = document.getElementById('socialLinksContainer');
    const addBtn = document.getElementById('addSocialLinkBtn');
    if (!container || !addBtn) {
      return;
    }
    const createRow = function (labelValue, urlValue) {
      const wrapper = document.createElement('div');
      wrapper.className = 'input-group social-link-row';
      wrapper.innerHTML = `
        <span class="input-group-text">平台</span>
        <input type="text" class="form-control" name="social_label" placeholder="例如：微博 / B站">
        <span class="input-group-text">地址</span>
        <input type="url" class="form-control" name="social_url" placeholder="https://example.com/you">
        <button class="btn btn-outline-danger social-link-remove" type="button">&times;</button>
      `;
      const labelInput = wrapper.querySelector('input[name="social_label"]');
      const urlInput = wrapper.querySelector('input[name="social_url"]');
      if (labelValue) {
        labelInput.value = labelValue;
      }
      if (urlValue) {
        urlInput.value = urlValue;
      }
      wrapper.querySelector('.social-link-remove').addEventListener('click', function () {
        if (container.children.length > 1) {
          wrapper.remove();
        } else {
          labelInput.value = '';
          urlInput.value = '';
        }
      });
      return wrapper;
    };
    addBtn.addEventListener('click', function () {
      container.appendChild(createRow('', ''));
    });
    Array.prototype.slice.call(container.querySelectorAll('.social-link-row')).forEach(function (row) {
      row.querySelector('.social-link-remove').addEventListener('click', function () {
        if (container.children.length > 1) {
          row.remove();
        } else {
          row.querySelector('input[name="social_label"]').value = '';
          row.querySelector('input[name="social_url"]').value = '';
        }
      });
    });
  })();
  (function manageAffiliations() {
    const container = document.getElementById('affiliationsContainer');
    const addBtn = document.getElementById('addAffiliationBtn');
    if (!container || !addBtn) {
      return;
    }
    const locationModal = document.getElementById('affiliationLocationModal');
    const locationSearch = document.getElementById('affiliationLocationSearch');
    const locationClearBtn = document.getElementById('affiliationLocationClearBtn');
    const locationConfirmBtn = document.getElementById('affiliationLocationConfirmBtn');
    const modalRadios = locationModal ? Array.prototype.slice.call(locationModal.querySelectorAll('.affiliation-location-radio')) : [];
    const modalRows = locationModal ? Array.prototype.slice.call(locationModal.querySelectorAll('.affiliation-location-row')) : [];
    let activeAffiliationRow = null;

    let affiliationIndex = container.querySelectorAll('.affiliation-row').length;
    const template = function (index) {
      return `
        <div class="row g-2 align-items-end">
          <div class="col-md-5">
            <label class="form-label d-block">地点</label>
            <div class="d-flex flex-wrap align-items-center gap-2">
              <div class="badge bg-light text-dark border affiliation-location-summary" data-default="选择地点">选择地点</div>
              <button type="button"
                      class="btn btn-outline-secondary btn-sm affiliation-location-picker"
                      data-bs-toggle="modal"
                      data-bs-target="#affiliationLocationModal"
                      data-affiliation-index="${index}"
                      data-selected="">
                选择地点
              </button>
            </div>
            <input type="hidden" name="affiliation_location_id" value="">
          </div>
          <div class="col-md-3 col-sm-6">
            <label class="form-label">关联关系</label>
            <select class="form-select" name="affiliation_relation">
              {% for key, label in relation_lookup.items() %}
              <option value="{{ key }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3 col-sm-6">
            <label class="form-label">备注</label>
            <input type="text" class="form-control" name="affiliation_note" placeholder="选填：班级 / 部门等">
          </div>
          <div class="col-md-1 d-grid">
            <button type="button" class="btn btn-outline-danger affiliation-remove">&times;</button>
          </div>
        </div>
      `;
    };

    function resetRow(row) {
      row.querySelectorAll('select').forEach(function (select) { select.selectedIndex = 0; });
      row.querySelectorAll('input[type="text"]').forEach(function (input) { input.value = ''; });
      const hidden = row.querySelector('input[name="affiliation_location_id"]');
      if (hidden) {
        hidden.value = '';
      }
      const summary = row.querySelector('.affiliation-location-summary');
      if (summary) {
        summary.textContent = summary.getAttribute('data-default') || '选择地点';
      }
      const pickerBtn = row.querySelector('.affiliation-location-picker');
      if (pickerBtn) {
        pickerBtn.setAttribute('data-selected', '');
      }
    }

    function attachRemove(row) {
      const btn = row.querySelector('.affiliation-remove');
      if (!btn) {
        return;
      }
      btn.addEventListener('click', function () {
        if (container.children.length > 1) {
          row.remove();
        } else {
          resetRow(row);
        }
      });
    }

    function attachLocationPicker(row) {
      if (!locationModal) {
        return;
      }
      const button = row.querySelector('.affiliation-location-picker');
      const hidden = row.querySelector('input[name="affiliation_location_id"]');
      if (!button || !hidden) {
        return;
      }
      button.addEventListener('click', function () {
        activeAffiliationRow = row;
        const current = hidden.value || '';
        if (locationSearch) {
          locationSearch.value = '';
          modalRows.forEach(function (r) { r.style.display = ''; });
        }
        modalRadios.forEach(function (radio) {
          radio.checked = radio.value === current;
        });
      });
    }

    Array.prototype.slice.call(container.querySelectorAll('.affiliation-row')).forEach(function (row, idx) {
      if (!row.getAttribute('data-affiliation-index')) {
        row.setAttribute('data-affiliation-index', String(idx));
      }
      const picker = row.querySelector('.affiliation-location-picker');
      if (picker) {
        picker.setAttribute('data-affiliation-index', row.getAttribute('data-affiliation-index'));
      }
      attachRemove(row);
      attachLocationPicker(row);
    });

    addBtn.addEventListener('click', function () {
      const wrapper = document.createElement('div');
      wrapper.className = 'affiliation-row border rounded p-3';
      wrapper.setAttribute('data-affiliation-index', String(affiliationIndex));
      wrapper.innerHTML = template(affiliationIndex);
      attachRemove(wrapper);
      attachLocationPicker(wrapper);
      container.appendChild(wrapper);
      affiliationIndex += 1;
    });

    if (locationModal) {
      if (locationClearBtn) {
        locationClearBtn.addEventListener('click', function () {
          const noneRadio = document.getElementById('affiliationLocationNone');
          if (noneRadio) {
            noneRadio.checked = true;
          }
        });
      }
      if (locationConfirmBtn) {
        locationConfirmBtn.addEventListener('click', function () {
          if (!activeAffiliationRow) {
            return;
          }
          const hidden = activeAffiliationRow.querySelector('input[name="affiliation_location_id"]');
          const summary = activeAffiliationRow.querySelector('.affiliation-location-summary');
          const pickerBtn = activeAffiliationRow.querySelector('.affiliation-location-picker');
          const selected = modalRadios.find(function (radio) { return radio.checked; });
          const defaultText = summary ? (summary.getAttribute('data-default') || '选择地点') : '选择地点';
          const value = selected ? selected.value : '';
          if (hidden) {
            hidden.value = value;
          }
          if (summary) {
            summary.textContent = value ? (selected.getAttribute('data-name') || defaultText) : defaultText;
          }
          if (pickerBtn) {
            pickerBtn.setAttribute('data-selected', value || '');
          }
          activeAffiliationRow = null;
        });
      }
      if (locationSearch) {
        locationSearch.addEventListener('input', function () {
          const term = this.value.trim().toLowerCase();
          modalRows.forEach(function (row) {
            const label = (row.getAttribute('data-label') || '').toLowerCase();
            row.style.display = term ? (label.indexOf(term) !== -1 ? '' : 'none') : '';
          });
        });
      }
      locationModal.addEventListener('hidden.bs.modal', function () {
        activeAffiliationRow = null;
        if (locationSearch) {
          locationSearch.value = '';
          modalRows.forEach(function (row) { row.style.display = ''; });
        }
      });
    }
  })();
</script>
{% endblock %}
