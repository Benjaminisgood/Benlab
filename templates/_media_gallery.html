{% macro render_media_gallery(entries, gallery_id, media_kind_labels, empty_text='暂无媒体文件', options=None) -%}
  {% set overlay_id = (gallery_id|string) ~ '-overlay' %}
  {% set gallery_class = options.gallery_class if options and options.gallery_class is not none else 'media-gallery' %}
  {% set grid_class = options.grid_class if options and options.grid_class is not none else 'media-gallery-grid' %}
  {% set card_class = options.card_class if options and options.card_class is not none else 'media-card' %}
  {% set enable_fullscreen = options.enable_fullscreen if options and options.enable_fullscreen is not none else true %}
  {% if entries %}
  <div class="{{ gallery_class }}" id="{{ gallery_id }}">
    <div class="{{ grid_class }}">
      {% for media in entries %}
      {% set kind = media.kind|default('file') %}
      <div class="{{ card_class }}{% if options and options.card_extra_class %} {{ options.card_extra_class }}{% endif %}"
           data-kind="{{ kind }}">
        {% if kind == 'image' %}
        <figure class="media-card-figure">
          <img src="{{ media.url }}"
               alt="{{ (media.display_name or '媒体文件')|e }}"
               class="media-card-img"
               loading="lazy"
               decoding="async">
        </figure>
        <div class="media-actions">
          {% if enable_fullscreen %}
          <button type="button"
                  class="btn btn-sm btn-primary media-play-btn"
                  data-action="open-fullscreen"
                  data-overlay-target="{{ overlay_id }}"
                  data-kind="image"
                  data-src="{{ media.url|e }}"
                  data-name="{{ (media.display_name or media_kind_labels.get('image', '图片'))|e }}"
                  aria-label="在大屏查看{{ (media.display_name or media_kind_labels.get('image', '图片'))|e }}">
            大屏查看
          </button>
          {% else %}
          <a href="{{ media.url|e }}"
             class="btn btn-sm btn-primary"
             target="_blank" rel="noopener"
             aria-label="查看{{ (media.display_name or media_kind_labels.get('image', '图片'))|e }}">
            查看图片
          </a>
          {% endif %}
          <a href="{{ media.url|e }}"
             class="btn btn-sm btn-outline-secondary media-download-btn"
             download="{{ (media.display_name or media_kind_labels.get('image', '图片'))|e }}"
             aria-label="下载{{ (media.display_name or media_kind_labels.get('image', '图片'))|e }}">
            下载
          </a>
        </div>
        {% if media.description %}
        <p class="media-description">{{ media.description }}</p>
        {% endif %}
        {% elif kind == 'video' %}
        <figure class="media-card-figure">
          <video class="media-card-video"
                 muted
                 playsinline
                 loop
                 autoplay
                 controls
                 preload="metadata"
                 poster="{{ media.poster|default('') }}"
                 aria-label="{{ (media.display_name or media_kind_labels.get('video', '视频'))|e }}">
            <source src="{{ media.url|e }}" type="{{ media.mimetype or 'video/mp4' }}">
            您的浏览器不支持视频播放。
          </video>
        </figure>
        <div class="media-actions">
          {% if enable_fullscreen %}
          <button type="button"
                  class="btn btn-sm btn-primary media-play-btn"
                  data-action="open-fullscreen"
                  data-overlay-target="{{ overlay_id }}"
                  data-kind="video"
                  data-src="{{ media.url|e }}"
                  data-name="{{ (media.display_name or media_kind_labels.get('video', '视频'))|e }}">
            全屏播放
          </button>
          {% endif %}
          <a href="{{ media.url|e }}"
             class="btn btn-sm btn-outline-secondary media-download-btn"
             download="{{ (media.display_name or media_kind_labels.get('video', '视频'))|e }}">
            下载
          </a>
        </div>
        {% elif kind == 'audio' %}
        <figure class="media-card-figure media-card-audio-figure">
          <audio class="media-card-audio"
                 controls
                 preload="metadata"
                 aria-label="{{ (media.display_name or media_kind_labels.get('audio', '音频'))|e }}">
            <source src="{{ media.url|e }}" type="{{ media.mimetype or 'audio/mpeg' }}">
            您的浏览器不支持音频播放。
          </audio>
        </figure>
        <div class="media-actions">
          <a href="{{ media.url|e }}"
             class="btn btn-sm btn-outline-secondary media-download-btn"
             download="{{ (media.display_name or media_kind_labels.get('audio', '音频'))|e }}">
            下载
          </a>
        </div>
        {% else %}
        <div class="media-file-link">
          <span class="media-tag">{{ media_kind_labels.get(kind, '文件') }}</span>
          <div class="media-actions">
            <a href="{{ media.url|e }}" target="_blank" rel="noopener"
               class="btn btn-sm btn-primary"
               aria-label="打开{{ media.display_name or media_kind_labels.get(kind, '文件') }}">
              打开
            </a>
            <a href="{{ media.url|e }}"
               class="btn btn-sm btn-outline-secondary media-download-btn"
               download="{{ (media.display_name or media_kind_labels.get(kind, '文件'))|e }}"
               aria-label="下载{{ (media.display_name or media_kind_labels.get(kind, '文件'))|e }}">
              下载
            </a>
          </div>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div>
  {% if enable_fullscreen %}
  <div class="media-lightbox" id="{{ overlay_id }}" hidden tabindex="-1" aria-hidden="true">
    <div class="media-lightbox-backdrop" data-action="close-fullscreen"></div>
    <div class="media-lightbox-dialog" role="dialog" aria-modal="true" aria-label="媒体预览">
      <button type="button" class="btn-close media-lightbox-close" data-action="close-fullscreen" aria-label="关闭预览"></button>
      <div class="media-lightbox-body" data-role="body"></div>
      <div class="media-lightbox-footer">
        <div class="media-lightbox-title" data-role="title" hidden></div>
      </div>
    </div>
  </div>
  {% endif %}
  {% else %}
  <div class="media-empty text-muted">
    <p class="mb-0">{{ empty_text }}</p>
  </div>
  {% endif %}
{%- endmacro %}
